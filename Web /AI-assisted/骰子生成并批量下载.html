<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2D骰子图像生成器</title>
    <!-- Tailwind CSS v3 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
        <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#e63946',
                        secondary: '#f5ebe0',
                        accent: '#457b9d',
                        neutral: '#f8f9fa',
                        dark: '#1d3557'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    boxShadow: {
                        'dice': '0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -1px rgba(0, 0, 0, 0.1)',
                        'button': '0 4px 0 0 rgba(0, 0, 0, 0.2)',
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .dice-dot {
                @apply absolute rounded-full bg-primary;
                width: 20%;
                height: 20%;
            }
            .button-3d {
                @apply transform active:translate-y-1 active:shadow-none transition-all duration-150;
            }
            .dice-container {
                @apply relative bg-white rounded-lg shadow-dice;
                width: 80px;
                height: 80px;
            }
            .dice-preview {
                @apply relative bg-white rounded-lg shadow-dice;
                width: 160px;
                height: 160px;
            }
            .dice-preview .dice-dot {
                width: 18%;
                height: 18%;
            }
        }
    </style>
</head>
<body class="bg-secondary min-h-screen flex flex-col items-center justify-center p-4">
    <div class="max-w-md w-full bg-white rounded-xl shadow-lg p-6 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-dark mb-2">2D骰子图像生成器</h1>
            <p class="text-gray-600">选择骰子点数，生成80×80像素的骰子图像</p>
        </header>

        <main class="flex flex-col items-center">
            <!-- 骰子预览区域 -->
            <div class="dice-preview mb-8" id="dicePreview">
                <!-- 骰子点数将通过JavaScript动态生成 -->
            </div>

            <!-- 点数选择区域 -->
            <div class="mb-4 text-center">
                <p class="text-gray-600 mb-2">选择要下载的骰子点数（可多选）</p>
                <div class="flex justify-center gap-2 mb-2">
                    <button id="selectAllButton" class="bg-gray-200 hover:bg-gray-300 text-gray-800 text-sm py-1 px-3 rounded">全选</button>
                    <button id="deselectAllButton" class="bg-gray-200 hover:bg-gray-300 text-gray-800 text-sm py-1 px-3 rounded">取消全选</button>
                </div>
            </div>
            <div class="grid grid-cols-3 gap-4 mb-8 w-full max-w-xs">
                <label class="flex flex-col items-center cursor-pointer">
                    <input type="checkbox" class="dice-checkbox hidden" value="1">
                    <div class="dice-option button-3d bg-primary text-white text-xl font-bold py-4 px-6 rounded-lg shadow-button w-full text-center">1</div>
                </label>
                <label class="flex flex-col items-center cursor-pointer">
                    <input type="checkbox" class="dice-checkbox hidden" value="2">
                    <div class="dice-option button-3d bg-primary text-white text-xl font-bold py-4 px-6 rounded-lg shadow-button w-full text-center">2</div>
                </label>
                <label class="flex flex-col items-center cursor-pointer">
                    <input type="checkbox" class="dice-checkbox hidden" value="3">
                    <div class="dice-option button-3d bg-primary text-white text-xl font-bold py-4 px-6 rounded-lg shadow-button w-full text-center">3</div>
                </label>
                <label class="flex flex-col items-center cursor-pointer">
                    <input type="checkbox" class="dice-checkbox hidden" value="4">
                    <div class="dice-option button-3d bg-primary text-white text-xl font-bold py-4 px-6 rounded-lg shadow-button w-full text-center">4</div>
                </label>
                <label class="flex flex-col items-center cursor-pointer">
                    <input type="checkbox" class="dice-checkbox hidden" value="5">
                    <div class="dice-option button-3d bg-primary text-white text-xl font-bold py-4 px-6 rounded-lg shadow-button w-full text-center">5</div>
                </label>
                <label class="flex flex-col items-center cursor-pointer">
                    <input type="checkbox" class="dice-checkbox hidden" value="6">
                    <div class="dice-option button-3d bg-primary text-white text-xl font-bold py-4 px-6 rounded-lg shadow-button w-full text-center">6</div>
                </label>
            </div>

            <!-- 操作按钮区域 -->
            <div class="flex flex-col gap-4 w-full max-w-xs">
                <div class="flex gap-4">
                    <button id="generateButton" class="button-3d bg-accent text-white font-bold py-3 px-6 rounded-lg shadow-button flex-1 flex items-center justify-center">
                        <i class="fa fa-download mr-2"></i> 下载选中
                    </button>
                    <button id="downloadAllButton" class="button-3d bg-green-600 text-white font-bold py-3 px-6 rounded-lg shadow-button flex-1 flex items-center justify-center">
                        <i class="fa fa-file-zip-o mr-2"></i> 下载全部
                    </button>
                </div>
                <button id="randomButton" class="button-3d bg-dark text-white font-bold py-3 px-6 rounded-lg shadow-button w-full flex items-center justify-center">
                    <i class="fa fa-random mr-2"></i> 随机选择一个
                </button>
            </div>
        </main>

        <footer class="mt-8 text-center text-gray-500 text-sm">
            <p>© 2025 2D骰子图像生成器 | 支持80×80像素</p>
        </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
        <script>
        // 当前选中的骰子点数（用于预览）
        let currentDiceValue = 1;
        // 选中的骰子点数列表（用于批量下载）
        let selectedDiceValues = [1];
        
        // 骰子点数布局配置
        const diceLayouts = {
            1: [
                [50, 50]  // 中心点
            ],
            2: [
                [25, 25], // 左上角
                [75, 75]  // 右下角
            ],
            3: [
                [25, 25], // 左上角
                [50, 50], // 中心点
                [75, 75]  // 右下角
            ],
            4: [
                [25, 25], // 左上角
                [25, 75], // 左下角
                [75, 25], // 右上角
                [75, 75]  // 右下角
            ],
            5: [
                [25, 25], // 左上角
                [25, 75], // 左下角
                [50, 50], // 中心点
                [75, 25], // 右上角
                [75, 75]  // 右下角
            ],
            6: [
                [25, 25], // 左上角
                [25, 50], // 左中
                [25, 75], // 左下角
                [75, 25], // 右上角
                [75, 50], // 右中
                [75, 75]  // 右下角
            ]
        };

        // DOM元素
        const dicePreview = document.getElementById('dicePreview');
        const diceCheckboxes = document.querySelectorAll('.dice-checkbox');
        const diceOptions = document.querySelectorAll('.dice-option');
        const generateButton = document.getElementById('generateButton');
        const downloadAllButton = document.getElementById('downloadAllButton');
        const randomButton = document.getElementById('randomButton');
        const selectAllButton = document.getElementById('selectAllButton');
        const deselectAllButton = document.getElementById('deselectAllButton');

        // 初始化
        function init() {
            // 渲染初始骰子（1点）
            renderDice(currentDiceValue, dicePreview);
            
            // 默认选中第一个复选框
            diceCheckboxes[0].checked = true;
            updateOptionStyle(diceOptions[0], true);
            
            // 添加事件监听器
            diceCheckboxes.forEach((checkbox, index) => {
                checkbox.addEventListener('change', () => {
                    const value = parseInt(checkbox.value);
                    const isChecked = checkbox.checked;
                    
                    // 更新选项样式
                    updateOptionStyle(diceOptions[index], isChecked);
                    
                    // 更新选中的骰子列表
                    if (isChecked) {
                        if (!selectedDiceValues.includes(value)) {
                            selectedDiceValues.push(value);
                        }
                    } else {
                        selectedDiceValues = selectedDiceValues.filter(v => v !== value);
                    }
                    
                    // 如果点击的是当前预览的骰子，则不改变预览
                    // 如果取消了当前预览的骰子的选择，则预览第一个选中的骰子
                    if (currentDiceValue === value && !isChecked && selectedDiceValues.length > 0) {
                        currentDiceValue = selectedDiceValues[0];
                        renderDice(currentDiceValue, dicePreview);
                    }
                });
                
                // 点击选项区域也可以切换复选框状态
                diceOptions[index].addEventListener('click', () => {
                    checkbox.checked = !checkbox.checked;
                    checkbox.dispatchEvent(new Event('change'));
                });
            });
            
            // 生成按钮点击事件（下载选中的骰子）
            generateButton.addEventListener('click', downloadSelectedDice);
            
            // 下载全部按钮点击事件
            downloadAllButton.addEventListener('click', downloadAllDice);
            
            // 随机按钮点击事件
            randomButton.addEventListener('click', () => {
                const randomValue = Math.floor(Math.random() * 6) + 1;
                currentDiceValue = randomValue;
                renderDice(randomValue, dicePreview);
                
                // 如果随机到的骰子未被选中，则选中它
                if (!selectedDiceValues.includes(randomValue)) {
                    const checkbox = Array.from(diceCheckboxes).find(cb => parseInt(cb.value) === randomValue);
                    if (checkbox) {
                        checkbox.checked = true;
                        checkbox.dispatchEvent(new Event('change'));
                    }
                }
            });
            
            // 全选按钮点击事件
            selectAllButton.addEventListener('click', () => {
                diceCheckboxes.forEach(checkbox => {
                    checkbox.checked = true;
                });
                selectedDiceValues = [1, 2, 3, 4, 5, 6];
                diceOptions.forEach(option => updateOptionStyle(option, true));
            });
            
            // 取消全选按钮点击事件
            deselectAllButton.addEventListener('click', () => {
                diceCheckboxes.forEach(checkbox => {
                    checkbox.checked = false;
                });
                selectedDiceValues = [];
                diceOptions.forEach(option => updateOptionStyle(option, false));
            });
        }
        
        // 更新选项样式
        function updateOptionStyle(option, isSelected) {
            if (isSelected) {
                option.classList.add('ring-4', 'ring-yellow-400');
            } else {
                option.classList.remove('ring-4', 'ring-yellow-400');
            }
        }

        // 渲染骰子
        function renderDice(value, container) {
            // 清空容器
            container.innerHTML = '';
            
            // 获取当前点数的布局
            const layout = diceLayouts[value];
            
            // 添加点数
            layout.forEach(position => {
                const dot = document.createElement('div');
                dot.classList.add('dice-dot');
                
                // 设置位置（使用百分比）
                dot.style.left = `${position[0]}%`;
                dot.style.top = `${position[1]}%`;
                
                // 调整中心点
                dot.style.transform = 'translate(-50%, -50%)';
                
                container.appendChild(dot);
            });
        }

        // 生成骰子图像并返回DataURL
        function generateDiceImage(value) {
            return new Promise((resolve, reject) => {
                // 创建一个临时的div来生成80x80的骰子
                const tempDice = document.createElement('div');
                tempDice.classList.add('dice-container');
                tempDice.style.position = 'absolute';
                tempDice.style.left = '-9999px';
                document.body.appendChild(tempDice);
                
                // 渲染80x80的骰子
                renderDice(value, tempDice);
                
                // 使用html2canvas库将div转换为图像
                html2canvas(tempDice).then(canvas => {
                    // 获取图像DataURL
                    const dataUrl = canvas.toDataURL('image/png');
                    
                    // 移除临时元素
                    document.body.removeChild(tempDice);
                    
                    resolve({
                        value: value,
                        dataUrl: dataUrl
                    });
                }).catch(error => {
                    reject(error);
                });
            });
        }
        
        // 下载选中的骰子图像
        function downloadSelectedDice() {
            if (selectedDiceValues.length === 0) {
                showNotification('请先选择要下载的骰子点数');
                return;
            }
            
            if (selectedDiceValues.length === 1) {
                // 如果只选中了一个，直接下载单个文件
                generateDiceImage(selectedDiceValues[0]).then(result => {
                    const link = document.createElement('a');
                    link.download = `dice-${result.value}.png`;
                    link.href = result.dataUrl;
                    link.click();
                    showNotification(`骰子${result.value}图像已生成并下载`);
                });
            } else {
                // 如果选中了多个，生成ZIP压缩包
                downloadDiceAsZip(selectedDiceValues);
            }
        }
        
        // 下载所有骰子图像（ZIP压缩包）
        function downloadAllDice() {
            downloadDiceAsZip([1, 2, 3, 4, 5, 6]);
        }
        
        // 将多个骰子图像打包成ZIP并下载
        function downloadDiceAsZip(values) {
            showNotification('正在生成ZIP压缩包，请稍候...');
            
            // 创建ZIP对象
            const zip = new JSZip();
            
            // 生成所有选中的骰子图像
            const promises = values.map(value => generateDiceImage(value));
            
            // 等待所有图像生成完成
            Promise.all(promises).then(results => {
                // 将图像添加到ZIP包
                results.forEach(result => {
                    // 从DataURL中提取二进制数据
                    const base64Data = result.dataUrl.split(',')[1];
                    zip.file(`dice-${result.value}.png`, base64Data, { base64: true });
                });
                
                // 生成ZIP文件
                zip.generateAsync({ type: 'blob' }).then(content => {
                    // 下载ZIP文件
                    saveAs(content, 'dice-images.zip');
                    
                    // 显示成功提示
                    showNotification(`已成功生成并下载${values.length}个骰子图像`);
                }).catch(error => {
                    console.error('Failed to generate ZIP file:', error);
                    showNotification('生成ZIP压缩包失败，请重试');
                });
            }).catch(error => {
                console.error('Failed to generate dice images:', error);
                showNotification('生成骰子图像失败，请重试');
            });
        }

        // 显示通知
        function showNotification(message) {
            // 创建通知元素
            const notification = document.createElement('div');
            notification.classList.add('fixed', 'top-4', 'right-4', 'bg-green-500', 'text-white', 'py-2', 'px-4', 'rounded-lg', 'shadow-lg', 'transition-opacity', 'duration-300');
            notification.textContent = message;
            
            // 添加到页面
            document.body.appendChild(notification);
            
            // 淡出效果
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 2000);
        }

        // 加载html2canvas库
        function loadHtml2Canvas() {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js';
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        // 页面加载完成后初始化
        window.addEventListener('DOMContentLoaded', () => {
            loadHtml2Canvas().then(init).catch(error => {
                console.error('Failed to load html2canvas:', error);
                alert('生成图像功能需要html2canvas库，请检查您的网络连接。');
            });
        });
    </script>
</body>
</html>
